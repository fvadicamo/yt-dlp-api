name: Codex Code Review

on:
  issue_comment:
    types: [created]

jobs:
  codex-review:
    name: Codex Review
    runs-on: ubuntu-latest

    # Only run when a trusted user comments "@codex review" on a PR
    # Security: Restrict to OWNER, MEMBER, or COLLABORATOR to prevent untrusted code execution
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@codex review') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER' ||
       github.event.comment.author_association == 'COLLABORATOR')

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('base_sha', pr.data.base.sha);
            core.setOutput('base_ref', pr.data.base.ref);
            core.setOutput('title', pr.data.title);
            core.setOutput('body', pr.data.body || 'No description provided.');

      - name: Checkout PR head
        env:
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
        run: git checkout "$HEAD_SHA"

      - name: Pre-fetch base and head refs
        env:
          BASE_REF: ${{ steps.pr.outputs.base_ref }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          git fetch --no-tags origin \
            "$BASE_REF" \
            "+refs/pull/${PR_NUMBER}/head"

      - name: Get changed files
        id: changed
        env:
          BASE_SHA: ${{ steps.pr.outputs.base_sha }}
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
        run: |
          FILES=$(git diff --name-only "${BASE_SHA}...${HEAD_SHA}")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: React to comment
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Prepare prompt file
        env:
          PR_NUMBER: ${{ github.event.issue.number }}
          REPOSITORY: ${{ github.repository }}
          BASE_SHA: ${{ steps.pr.outputs.base_sha }}
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_BODY: ${{ steps.pr.outputs.body }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          # Replace placeholders in prompt template
          # Using env vars to prevent shell injection from user-controlled content
          sed -e "s|{{ PR_NUMBER }}|${PR_NUMBER}|g" \
              -e "s|{{ REPOSITORY }}|${REPOSITORY}|g" \
              -e "s|{{ BASE_SHA }}|${BASE_SHA}|g" \
              -e "s|{{ HEAD_SHA }}|${HEAD_SHA}|g" \
              -e "s|{{ PR_TITLE }}|${PR_TITLE//|/\\|}|g" \
              .github/codex/review-prompt.md > /tmp/codex-prompt.md

          # Append PR body (handle multiline safely)
          echo "" >> /tmp/codex-prompt.md
          printf '%s\n' "$PR_BODY" >> /tmp/codex-prompt.md

          # Append changed files
          echo "" >> /tmp/codex-prompt.md
          echo "Changed files:" >> /tmp/codex-prompt.md
          printf '%s\n' "$CHANGED_FILES" >> /tmp/codex-prompt.md

      - name: Run Codex Review
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: /tmp/codex-prompt.md
          output-schema-file: .github/codex/codex-output-schema.json
          output-file: codex-output.json
          sandbox: read-only
          safety-strategy: drop-sudo

      - name: Post inline review comments
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
          HEAD_SHA: ${{ steps.pr.outputs.head_sha }}
          PR_NUMBER: ${{ github.event.issue.number }}
          REPOSITORY: ${{ github.repository }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
        run: |
          if [ ! -f codex-output.json ]; then
            echo "No Codex output file found"
            exit 0
          fi

          # Check if there are findings
          FINDINGS_COUNT=$(jq '.findings | length' codex-output.json)
          echo "Found $FINDINGS_COUNT findings"

          if [ "$FINDINGS_COUNT" -eq 0 ]; then
            echo "No findings to post"
            # Post summary comment only
            SUMMARY=$(jq -r '.overall_explanation' codex-output.json)
            gh pr comment "$PR_NUMBER" --body "## Codex Code Review

          No issues found.

          **Summary**: $SUMMARY

          ---
          _Triggered by @${COMMENT_USER}_"
            exit 0
          fi

          # Post each finding as an inline comment
          jq -c '.findings[]' codex-output.json | while IFS= read -r finding; do
            TITLE=$(echo "$finding" | jq -r '.title')
            BODY=$(echo "$finding" | jq -r '.body')
            PRIORITY=$(echo "$finding" | jq -r '.priority')
            CONFIDENCE=$(echo "$finding" | jq -r '.confidence_score')
            FILE_PATH=$(echo "$finding" | jq -r '.code_location.absolute_file_path')
            LINE_START=$(echo "$finding" | jq -r '.code_location.line_range.start')
            LINE_END=$(echo "$finding" | jq -r '.code_location.line_range.end')

            # Map priority to label
            case $PRIORITY in
              0) PRIORITY_LABEL="CRITICAL" ;;
              1) PRIORITY_LABEL="HIGH" ;;
              2) PRIORITY_LABEL="MEDIUM" ;;
              3) PRIORITY_LABEL="LOW" ;;
              *) PRIORITY_LABEL="INFO" ;;
            esac

            # Build comment body
            COMMENT_BODY="**[$PRIORITY_LABEL]** $TITLE

          $BODY

          _Confidence: ${CONFIDENCE}_"

            # Create payload for GitHub API
            if [ "$LINE_START" -eq "$LINE_END" ]; then
              # Single line comment
              PAYLOAD=$(jq -n \
                --arg body "$COMMENT_BODY" \
                --arg commit_id "$HEAD_SHA" \
                --arg path "$FILE_PATH" \
                --argjson line "$LINE_END" \
                '{body: $body, commit_id: $commit_id, path: $path, line: $line, side: "RIGHT"}')
            else
              # Multi-line comment
              PAYLOAD=$(jq -n \
                --arg body "$COMMENT_BODY" \
                --arg commit_id "$HEAD_SHA" \
                --arg path "$FILE_PATH" \
                --argjson line "$LINE_END" \
                --argjson start_line "$LINE_START" \
                '{body: $body, commit_id: $commit_id, path: $path, line: $line, start_line: $start_line, side: "RIGHT", start_side: "RIGHT"}')
            fi

            # Post comment via GitHub API
            echo "Posting comment on $FILE_PATH:$LINE_START-$LINE_END"
            curl -sS -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPOSITORY}/pulls/${PR_NUMBER}/comments" \
              -d "$PAYLOAD" || echo "Failed to post comment (file may not be in diff)"
          done

          # Post summary comment
          SUMMARY=$(jq -r '.overall_explanation' codex-output.json)
          gh pr comment "$PR_NUMBER" --body "## Codex Code Review Summary

          Found **$FINDINGS_COUNT** issue(s). See inline comments above.

          **Overall**: $SUMMARY

          ---
          _Triggered by @${COMMENT_USER}_"
